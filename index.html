<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>good-day íƒì¼ ì„œë¹„ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .day-cell { min-height: 95px; transition: all 0.2s; border-bottom: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; }
        .day-cell:hover { background-color: #f1f5f9; cursor: pointer; }
        .good-day { background-color: #ecfdf5; color: #065f46; }
        .bad-day { background-color: #fff1f2; color: #9f1239; }
        .normal-day { background-color: #eff6ff; color: #1e40af; }
        .selected-day { ring: 2px inset #4f46e5; background-color: #eef2ff; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        <header class="bg-gradient-to-r from-indigo-700 to-blue-700 p-6 text-white text-center">
            <h1 class="text-2xl font-bold italic">â˜¯ï¸ good-day íƒì¼ ì„œë¹„ìŠ¤</h1>
            <p class="text-sm opacity-90 mt-2">ì •ë°€ ìŒë ¥ ë³€í™˜ ê¸°ë°˜ ë³¸ëª…ê´˜ ì‚°ì¶œ ë° ë¬´í•œ ë‹¬ë ¥ ì‹œìŠ¤í…œ</p>
        </header>

        <main class="p-6 space-y-6">
            <!-- ì…ë ¥ ì„¹ì…˜ -->
            <section class="bg-gray-50 p-6 rounded-2xl border border-gray-200 shadow-sm">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì„±ë³„</label>
                        <select id="gender" class="w-full border p-2 rounded bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="male">ë‚¨ì„±</option>
                            <option value="female">ì—¬ì„±</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ìƒë…„ì›”ì¼ ë° ì‹œê°„</label>
                        <div class="flex gap-1">
                            <input type="date" id="birthDate" class="w-2/3 border p-2 rounded outline-none text-sm">
                            <input type="time" id="birthTime" class="w-1/3 border p-2 rounded outline-none text-sm">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">ì…ë ¥ ê¸°ì¤€</label>
                        <select id="calendarType" class="w-full border p-2 rounded bg-white outline-none focus:ring-2 focus:ring-indigo-500">
                            <option value="solar">ì–‘ë ¥ìœ¼ë¡œ ì…ë ¥</option>
                            <option value="lunar">ìŒë ¥ìœ¼ë¡œ ì…ë ¥</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="analyze()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl transition-all shadow-lg">
                            ğŸ“Š ìƒì¼ ë¶„ì„í•˜ê¸°
                        </button>
                    </div>
                </div>
            </section>

            <!-- ë‹¬ë ¥ ì„¹ì…˜ -->
            <section>
                <div class="flex justify-between items-center mb-4 px-2">
                    <div class="flex items-center gap-4">
                        <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition-colors">â—€</button>
                        <h2 class="text-xl font-bold text-gray-800" id="currentMonthDisplay">2026ë…„ 2ì›”</h2>
                        <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition-colors">â–¶</button>
                    </div>
                    <div class="text-right">
                        <span id="myeongGwaDisplay" class="text-sm font-bold text-indigo-600 block"></span>
                        <span id="lunarRefDisplay" class="text-[10px] text-gray-400"></span>
                    </div>
                </div>
                <div class="grid grid-cols-7 text-center font-bold text-gray-500 text-[10px] mb-2 border-b pb-2 uppercase tracking-widest">
                    <div class="text-red-500">Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div class="text-blue-500">Sat</div>
                </div>
                <div id="calendarContainer" class="calendar-grid border-t border-l rounded-lg overflow-hidden border-gray-200"></div>
            </section>

            <!-- ë¦¬í¬íŠ¸ ì„¹ì…˜ -->
            <section id="analysisResult" class="hidden bg-white border-2 border-indigo-100 p-6 rounded-2xl shadow-sm">
                <div id="reportContent"></div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB-eOuTEl0Ac9umonVhD82suBOVnvjZM1k",
            authDomain: "good-day-bc3a7.firebaseapp.com",
            projectId: "good-day-bc3a7",
            storageBucket: "good-day-bc3a7.firebasestorage.app",
            messagingSenderId: "681248607698",
            appId: "1:681248607698:3c5758ef797d890910c0b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const artifactId = "good-day-bc3a7";

        let currentUser = null;

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) { loadData(); } else { try { await signInAnonymously(auth); } catch(e) {} }
        });

        async function loadData() {
            if (!currentUser) return;
            const userDoc = doc(db, 'artifacts', artifactId, 'users', currentUser.uid, 'settings', 'profile');
            const snap = await getDoc(userDoc);
            if (snap.exists()) {
                const data = snap.data();
                document.getElementById('birthDate').value = data.birthDate || '';
                document.getElementById('birthTime').value = data.birthTime || '';
                document.getElementById('gender').value = data.gender || 'male';
                document.getElementById('calendarType').value = data.calendarType || 'solar';
                window.analyze(false);
            }
        }

        window.saveData = async (data) => {
            if (!currentUser) return;
            try { await setDoc(doc(db, 'artifacts', artifactId, 'users', currentUser.uid, 'settings', 'profile'), data); } catch (e) {}
        };
    </script>

    <script>
        let viewDate = new Date(); 
        let isAnalyzed = false;
        let userData = { myeongGwa: 0, lunarYear: 0 };

        const saengGiTable = {
            1: { 'ë¶': 'ë³µë•', 'ë¶ë™': 'ê·€í˜¼', 'ë™': 'ì²œì˜', 'ë‚¨ë™': 'ìƒê¸°', 'ë‚¨': 'ìœ í˜¼', 'ë‚¨ì„œ': 'ì ˆì²´', 'ì„œ': 'í™”í•´', 'ë¶ì„œ': 'ì ˆëª…' },
            2: { 'ë¶': 'ì ˆëª…', 'ë¶ë™': 'ìƒê¸°', 'ë™': 'í™”í•´', 'ë‚¨ë™': 'ì ˆì²´', 'ë‚¨': 'ê·€í˜¼', 'ë‚¨ì„œ': 'ë³µë•', 'ì„œ': 'ì²œì˜', 'ë¶ì„œ': 'ìœ í˜¼' },
            3: { 'ë¶': 'ìƒê¸°', 'ë¶ë™': 'í™”í•´', 'ë™': 'ë³µë•', 'ë‚¨ë™': 'ìœ í˜¼', 'ë‚¨': 'ì²œì˜', 'ë‚¨ì„œ': 'ì ˆëª…', 'ì„œ': 'ì ˆì²´', 'ë¶ì„œ': 'ê·€í˜¼' },
            4: { 'ë¶': 'ì²œì˜', 'ë¶ë™': 'ì ˆì²´', 'ë™': 'ìœ í˜¼', 'ë‚¨ë™': 'ë³µë•', 'ë‚¨': 'ìƒê¸°', 'ë‚¨ì„œ': 'ê·€í˜¼', 'ì„œ': 'ì ˆëª…', 'ë¶ì„œ': 'í™”í•´' },
            6: { 'ë¶': 'ê·€í˜¼', 'ë¶ë™': 'ì²œì˜', 'ë™': 'ì ˆëª…', 'ë‚¨ë™': 'í™”í•´', 'ë‚¨': 'ì ˆì²´', 'ë‚¨ì„œ': 'ìœ í˜¼', 'ì„œ': 'ìƒê¸°', 'ë¶ì„œ': 'ë³µë•' },
            7: { 'ë¶': 'í™”í•´', 'ë¶ë™': 'ì ˆëª…', 'ë™': 'ì ˆì²´', 'ë‚¨ë™': 'ê·€í˜¼', 'ë‚¨': 'ìœ í˜¼', 'ë‚¨ì„œ': 'ì²œì˜', 'ì„œ': 'ë³µë•', 'ë¶ì„œ': 'ìƒê¸°' },
            8: { 'ë¶': 'ìœ í˜¼', 'ë¶ë™': 'ë³µë•', 'ë™': 'ì ˆëª…', 'ë‚¨ë™': 'ì ˆì²´', 'ë‚¨': 'í™”í•´', 'ë‚¨ì„œ': 'ìƒê¸°', 'ì„œ': 'ê·€í˜¼', 'ë¶ì„œ': 'ì²œì˜' },
            9: { 'ë¶': 'ì ˆì²´', 'ë¶ë™': 'ìœ í˜¼', 'ë™': 'ìƒê¸°', 'ë‚¨ë™': 'ì²œì˜', 'ë‚¨': 'ë³µë•', 'ë‚¨ì„œ': 'í™”í•´', 'ì„œ': 'ì ˆëª…', 'ë¶ì„œ': 'ê·€í˜¼' }
        };

        const aiExplainBase = {
            'ìƒê¸°': { summary: "ì „ë°˜ì ì¸ ê¸°ìš´ì´ ê°•í•œ ëŒ€ê¸¸ì¼ì…ë‹ˆë‹¤.", action: ["ì‹œì‘", "í™•ì¥"], recommend: "ê²°í˜¼, ê°œì—…, ê³„ì•½" },
            'ì²œì˜': { summary: "ê·€ì¸ì˜ ë„ì›€ê³¼ ì¹˜ìœ ì˜ ìš´ì´ ê°•í•©ë‹ˆë‹¤.", action: ["ìƒë‹´", "ì¹˜ë£Œ"], recommend: "ë³‘ì›, í˜‘ìƒ" },
            'ë³µë•': { summary: "ì¬ë¬¼ê³¼ í™”í•©ì˜ ìš´ì´ ë”°ë¥´ëŠ” ë‚ ì…ë‹ˆë‹¤.", action: ["ë§Œë‚¨", "ì¬ë¬´"], recommend: "ê°€ì¡± í–‰ì‚¬, íˆ¬ì" },
            'ì ˆì²´': { summary: "ê¸°ìš´ì´ ë§‰í˜€ íœ´ì‹ì´ í•„ìš”í•œ ë‚ ì…ë‹ˆë‹¤.", action: ["ì •ì§€", "íœ´ì‹"], recommend: "ì¬ì •ë¹„" },
            'ìœ í˜¼': { summary: "ì •ì‹ ì´ ì‚°ë§Œí•´ì§€ê¸° ì‰¬ìš´ ë¬´ë‚œí•œ ë‚ ì…ë‹ˆë‹¤.", action: ["ì¼ìƒìœ ì§€"], recommend: "ë£¨í‹´ ì—…ë¬´" },
            'ê·€í˜¼': { summary: "ë§ˆë¬´ë¦¬ì™€ ì •ë¦¬ì— ì í•©í•œ ë‚ ì…ë‹ˆë‹¤.", action: ["ë§ˆê°", "ì •ë¦¬"], recommend: "íšŒê³ , ì •ì‚°" },
            'í™”í•´': { summary: "êµ¬ì„¤ìˆ˜ë‚˜ ì¶©ëŒì„ ì£¼ì˜í•´ì•¼ í•  í‰ì¼ì…ë‹ˆë‹¤.", action: ["ë§ì¡°ì‹¬"], recommend: "ì™¸ì¶œ ìì œ" },
            'ì ˆëª…': { summary: "ê¸°ìš´ì´ ë‹¤í•œ ëŒ€í‰ì¼ë¡œ ìì¤‘ì´ í•„ìš”í•©ë‹ˆë‹¤.", action: ["ì¹¨ë¬µ"], recommend: "ì •ì ì¸ í™œë™" }
        };

        function getLunarInfo(date) {
            try {
                const options = { calendar: 'chinese', year: 'numeric', month: 'numeric', day: 'numeric' };
                const formatter = new Intl.DateTimeFormat('en-u-ca-chinese', options);
                const parts = formatter.formatToParts(date);
                const info = {};
                parts.forEach(p => { if (p.type !== 'literal') info[p.type] = p.value; });
                const lunarYear = parseInt(info.relatedYear || info.year.replace(/[^0-9]/g, ''));
                return {
                    year: lunarYear,
                    month: parseInt(info.month),
                    day: parseInt(info.day)
                };
            } catch (e) {
                return { year: date.getFullYear(), month: date.getMonth() + 1, day: date.getDate() };
            }
        }

        function getMyeongGwa(year, gender) {
            const sum = [...String(year)].reduce((a, b) => a + Number(b), 0);
            let num = sum % 9 || 9;
            let res;
            if (gender === 'male') {
                res = num <= 5 ? 10 - num : 19 - num;
            } else {
                res = num <= 5 ? num + 5 : num + 4;
            }
            res = res % 9 || 9;
            if (res === 5) res = (gender === 'male') ? 2 : 8;
            return res;
        }

        function getDayDirection(date) {
            const directions = ['ë¶','ë¶ë™','ë™','ë‚¨ë™','ë‚¨','ë‚¨ì„œ','ì„œ','ë¶ì„œ'];
            return directions[date.getDate() % 8];
        }

        function matchSaengGi(mGua, direction) {
            if (!saengGiTable[mGua]) return { type: "í‰ë²”", status: "normal" };
            const type = saengGiTable[mGua][direction];
            let status = (['ìƒê¸°','ì²œì˜','ë³µë•'].includes(type)) ? 'good' : (['í™”í•´','ì ˆëª…'].includes(type) ? 'bad' : 'normal');
            return { type, status, ...aiExplainBase[type] };
        }

        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            const display = document.getElementById('currentMonthDisplay');
            if (!container) return;
            container.innerHTML = '';
            
            const year = viewDate.getFullYear();
            const month = viewDate.getMonth();
            display.innerText = `${year}ë…„ ${month + 1}ì›”`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.className = 'day-cell bg-gray-50 opacity-40 border-r border-b';
                container.appendChild(empty);
            }

            for (let d = 1; d <= lastDate; d++) {
                const dateObj = new Date(year, month, d);
                const lunar = getLunarInfo(dateObj);
                const direction = getDayDirection(dateObj);
                const fortune = isAnalyzed ? matchSaengGi(userData.myeongGwa, direction) : { type: "", status: "" };
                
                const cell = document.createElement('div');
                cell.className = `day-cell p-2 flex flex-col justify-between cursor-pointer border-r border-b`;
                if (isAnalyzed && fortune.status) cell.classList.add(fortune.status + '-day');
                
                cell.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="text-xs font-bold ${dateObj.getDay() === 0 ? 'text-red-500' : (dateObj.getDay() === 6 ? 'text-blue-500' : '')}">${d}</span>
                            <div class="text-[8px] opacity-60 leading-tight">ìŒ ${lunar.month}.${lunar.day}</div>
                        </div>
                        <span class="text-[8px] opacity-40 font-bold">${direction}</span>
                    </div>
                    <div class="text-[9px] font-bold text-center mb-1">${fortune.type || ""}</div>
                `;
                cell.onclick = () => showDetail(d, direction, fortune, dateObj, lunar);
                container.appendChild(cell);
            }
        }

        function showDetail(day, direction, fortune, dateObj, lunar) {
            if (!isAnalyzed) return;
            const res = document.getElementById('analysisResult');
            res.classList.remove('hidden');
            const content = document.getElementById('reportContent');
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="flex justify-between items-center border-b pb-2">
                        <h3 class="text-lg font-bold">ğŸ“œ ${dateObj.toLocaleDateString()} (ìŒë ¥ ${lunar.year}.${lunar.month}.${lunar.day})</h3>
                        <span class="text-xs px-2 py-1 bg-indigo-100 text-indigo-700 rounded-full font-bold">ë°©ìœ„: ${direction}</span>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 rounded-xl border ${fortune.status === 'good' ? 'bg-emerald-50 border-emerald-200' : (fortune.status === 'bad' ? 'bg-rose-50 border-rose-200' : 'bg-blue-50 border-blue-200')}">
                            <p class="text-[10px] font-bold opacity-60 uppercase mb-1">ìš´ê¸° íŒì •</p>
                            <p class="text-xl font-black">${fortune.type}</p>
                            <p class="text-sm mt-1 leading-snug">${fortune.summary || 'ì¼ì§„ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.'}</p>
                        </div>
                        <div class="p-4 bg-gray-50 rounded-xl border border-gray-200">
                            <p class="text-[10px] font-bold text-gray-400 uppercase mb-1">AI íƒì¼ ê°€ì´ë“œ</p>
                            <p class="text-sm font-bold text-indigo-700">âœ¨ ì¶”ì²œ: ${fortune.recommend || 'ì¼ìƒ ìœ ì§€'}</p>
                            <div class="flex flex-wrap gap-1 mt-3">
                                ${(fortune.action || ['ê´€ë§']).map(a => `<span class="bg-white border border-gray-200 text-[10px] px-2 py-0.5 rounded text-gray-600">#${a}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            res.scrollIntoView({ behavior: 'smooth' });
        }

        window.analyze = function(shouldSave = true) {
            const birthStr = document.getElementById('birthDate').value;
            if (!birthStr) { if (shouldSave) alert("ìƒë…„ì›”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const parts = birthStr.split('-');
            const birthDateObj = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 0, 0, 0);
            
            const gender = document.getElementById('gender').value;
            const time = document.getElementById('birthTime').value;
            const calType = document.getElementById('calendarType').value;

            let finalYear;
            if (calType === 'solar') {
                const lunar = getLunarInfo(birthDateObj);
                finalYear = lunar.year;
            } else {
                finalYear = parseInt(parts[0]);
            }

            userData.myeongGwa = getMyeongGwa(finalYear, gender);
            userData.lunarYear = finalYear;
            
            isAnalyzed = true;
            document.getElementById('myeongGwaDisplay').innerText = `ë‚˜ì˜ ë³¸ëª…ê´˜: ${userData.myeongGwa}ê´˜`;
            document.getElementById('lunarRefDisplay').innerText = `(ë¶„ì„ ê¸°ì¤€: ${finalYear}ë…„ ìŒë ¥ ì„¸ì°¨)`;
            renderCalendar();

            if (shouldSave && typeof window.saveData === 'function') {
                window.saveData({ birthDate: birthStr, birthTime: time, gender, calendarType: calType });
            }
        };

        window.changeMonth = function(offset) {
            viewDate.setMonth(viewDate.getMonth() + offset);
            renderCalendar();
        };

        window.onload = renderCalendar;
    </script>
</body>
</html>